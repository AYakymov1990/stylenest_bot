# Функционал бота - Удаление пользователей и напоминания

## Обзор функционала

### 1. Удаление пользователей после окончания подписки (`app/tasks/expiry.py`)

**Что делает:**
- Проверяет активные подписки, которые уже истекли (`ends_at <= now`)
- Удаляет пользователей из канала через ban/unban
- Помечает подписки как `expired` в БД
- Отправляет уведомление об истечении подписки

**Логика удаления:**
```python
# Сначала банит пользователя
await bot.ban_chat_member(chat_id=settings.CHANNEL_ID, user_id=user_id)
# Затем разбанивает (это удаляет из канала)
await bot.unban_chat_member(chat_id=settings.CHANNEL_ID, user_id=user_id, only_if_banned=True)
```

**Логи:**
- `[EXPIRY] Проверка истекших подписок на {время}`
- `[EXPIRY] Найдено {количество} истекших подписок`
- `[EXPIRY] Обработка подписки {id} для пользователя {tg_id}`
- `[EXPIRY] Пользователь {tg_id} удален из канала`
- `[EXPIRY] Уведомление об истечении отправлено пользователю {tg_id}`

### 2. Напоминания о заканчивающихся подписках (`app/tasks/reminders.py`)

**Что делает:**
- Напоминание за 3 дня до окончания
- Напоминание за 1 день до окончания
- Отправляет кнопки для продления подписки

**Логика напоминаний:**
```python
# За 3 дня: ends_at в диапазоне (now+3d, now+3d+1h)
# За 1 день: ends_at в диапазоне (now+1d, now+1d+1h)
# Только для активных подписок, которым еще не отправляли напоминание
```

**Логи:**
- `[REMINDERS] Проверка напоминаний на {время}`
- `[REMINDERS] Найдено {количество} подписок для напоминания за 3 дня`
- `[REMINDERS] Отправка напоминания за 3 дня пользователю {tg_id}`
- `[REMINDERS] Уведомление отправлено пользователю {tg_id}`

### 3. Worker (`app/tasks/worker.py`)

**Что делает:**
- Запускает циклы reminders и expiry каждые 60 секунд
- Обрабатывает Telegram updates
- Логирует все операции

**Логи:**
- `[WORKER] Запуск worker'а`
- `[WORKER] Запуск цикла напоминаний`
- `[WORKER] Запуск цикла обработки истекших подписок`
- `[WORKER] Все задачи запущены: polling, reminders, expiry`

## Файлы логов

- `logs/bot.log` - общие логи бота
- `logs/tasks.log` - логи задач (reminders, expiry, worker)

## Запуск

```bash
# Запуск worker'а (включает все функции)
python -m app.tasks.worker

# Только напоминания (для тестирования)
python -m app.tasks.reminders

# Только обработка истекших (для тестирования)
python -m app.tasks.expiry
```

## Настройки

- `CHECK_INTERVAL = 60` - интервал проверки в секундах
- `CHANNEL_ID` - ID канала для удаления пользователей
- `BOT_TOKEN` - токен бота

## Важные моменты

1. **Дублирование убрано** - логика уведомления об истекших подписках перенесена из reminders.py в expiry.py
2. **Логирование настроено** - все операции логируются с префиксами [EXPIRY], [REMINDERS], [WORKER]
3. **Обработка ошибок** - все исключения логируются, но не останавливают работу циклов
4. **Безопасность** - пользователи удаляются через ban/unban, что корректно работает с Telegram API
